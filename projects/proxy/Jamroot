include ../../cxxflags.jam ;

import os ;

# below feature rule come from http://www.boost.org/doc/tools/build/doc/html/bbv2/extending/features.html

import feature : feature ;
import modules : poke ;

# this feature is defined so we can add a dependency on <distri>lenny for some targets
# disabled because in our current code it finds the right library
#feature distri : none lenny : propagated ;

# No need to make it a new variant after all
#variant lenny : release ;

path-constant TOP : . ;
constant CONFIG_DIR : ../../projects/redemption_configs ;
constant SRCDIR : ../../src ;
constant INCLUDEDIR : ../../include ;
constant TESTDIR : ../../tests ;
constant MODULEDIR : ../../modules ;
constant SYSTEMDIR : ../../src/system/linux ;

#echo "toolset" [ feature.get-values toolset ] ;

# Returns environment value if it exists or default otherwise.
# Allow us to customize install path with shell variables like $PREFIX...
# (this is bad practice and should be replaced by a site configuration file
# but I until now I miserably failed creating a clean separate configuration file)
rule setvar ( env : default * )
{
    if [ os.environ $(env) ]
    {
        return [ os.environ $(env) ] ;
    }
    else
    {
        return $(default) ;
    }
}

constant ARCH : [ SHELL "lscpu | perl -ne 'if (/^Architecture.*(x86_64|i386|i686)/) {print $1};'" ] ;
# constant ARCH : [ SHELL "lscpu | perl -ane 'my %h = map { $F[0], $F[1] } <>; print $h{q{Architecture:}}'" ] ;
constant PYTHON_VER : [ SHELL "perl -e 'for my $x (q{python2.7}, q{python2.6}) { if (-e q{/usr/include/}.$x.q{/Python.h}){ print $x; last;}};'" ] ;
constant PYTHON_INCLUDE : [ SHELL "perl -e 'for my $x (q{python2.7}, q{python2.6}) { if (-e q{/usr/include/}.$x.q{/Python.h}){ print q{/usr/include/}.$x; last;}};'" ] ;


constant FIXTURES_PATH : [ setvar FIXTURES_PATH : $(TESTDIR)/fixtures ] ;
constant INSTALLDIR : [ setvar DESTDIR : "" ] ;
constant PREFIX : [ setvar PREFIX : /usr/local ] ;
constant BIN_PREFIX : [ setvar BIN_PREFIX : $(PREFIX)/bin ] ;
constant LIB_PREFIX : [ setvar LIB_PREFIX : $(PREFIX)/lib ] ;
constant SHARE_PREFIX : [ setvar SHARE_PREFIX : $(PREFIX)/share/rdpproxy ] ;
constant RECORD_TMP_PATH : [ setvar RECORD_TMP_PATH : /var/rdpproxy/tmp ] ;
constant RECORD_PATH : [ setvar RECORD_PATH : /var/rdpproxy/recorded ] ;
constant ETC_PREFIX : [ setvar ETC_PREFIX : /etc/rdpproxy ] ;
constant CERT_PREFIX : [ setvar CERT_PREFIX : /etc/rdpproxy/cert ] ;
constant HASH_PATH : [ setvar HASH_PATH : /var/rdpproxy/hash ] ;
constant PERSISTENT_PATH : [ setvar PERSISTENT_PATH : /var/lib/redemption/cache ] ;
constant DRIVE_REDIRECTION_PATH : [ setvar DRIVE_REDIRECTION_PATH : /var/rdpproxy/drive_redirection ] ;

constant COVERAGE_PREFIX : [ setvar COVERAGE_PREFIX : "" ] ;

constant PNG_DEBUG : <variant>debug:<library>png ;

rule defines ( properties * )
{
    local defs ;
    defs += <define>CFG_PATH='\"$(ETC_PREFIX)\"' ;
    defs += <define>RECORD_PATH='\"$(RECORD_PATH)\"' ;
    defs += <define>RECORD_TMP_PATH='\"$(RECORD_TMP_PATH)\"' ;
    defs += <define>FLV_PATH='\"$(RECORD_TMP_PATH)\"' ;
    defs += <define>OCR_PATH='\"$(RECORD_TMP_PATH)\"' ;
    defs += <define>PNG_PATH='\"$(RECORD_TMP_PATH)\"' ;
    defs += <define>WRM_PATH='\"$(RECORD_PATH)\"' ;
    defs += <define>HASH_PATH='\"$(HASH_PATH)\"' ;
    defs += <define>LICENSE_PATH='\"$(CERT_PREFIX)/rdplicense\"' ;
    defs += <define>CERTIF_PATH='\"$(CERT_PREFIX)/rdp\"' ;
    defs += <define>FIXTURES_PATH='\"$(FIXTURES_PATH)\"' ;
    defs += <define>PERSISTENT_PATH='\"$(PERSISTENT_PATH)\"' ;
    defs += <define>DRIVE_REDIRECTION_PATH='\"$(DRIVE_REDIRECTION_PATH)\"' ;
    if [ os.environ VERBOSE ]
    {
        defs += <define>VERBOSE ;
    }
    return $(defs) ;
}
variant coverage : debug : <cxxflags>--profile-arcs <cxxflags>--test-coverage <cxxflags>--coverage <link>shared ;

#gcov -a -c -b -f -o bin/gcc-4.6/coverage/tests/test_stream.gcno bin/gcc-4.6/coverage/test_stream

lib gcov : : <name>gcov : ;

constant GCOV : <variant>coverage:<library>gcov ;
constant GCOV_NO_BUILD : <variant>coverage:<build>no ;


project redemption
    : requirements
    <include>$(SRCDIR)
    <include>$(INCLUDEDIR)
    <include>$(SYSTEMDIR)
    <include>$(SRCDIR)/headers
    <include>$(MODULEDIR)/includes

    <include>$(CONFIG_DIR)/redemption_src
    <include>$(CONFIG_DIR)/include/autogen
    <include>$(CONFIG_DIR)/include/variant


    <conditional>@defines

    <cxxflags>-std=c++11

    $(CXXFLAGS)

#    <cxxflags>-fpie
    <cxxflags>-fPIC


    <define>_FILE_OFFSET_BITS=64
    <define>_LARGEFILE64_SOURCE

    <define>__STDC_FORMAT_MACROS

    <define>PUBLIC

   : default-build release

;

explicit install instexe install-bin install-etc install-etc-themes install-share install-lib check_coverage exe ;

alias instexe : install-bin ;
alias install : install-bin install-etc install-etc-themes install-share install-lib ;
alias exe     : rdpproxy rdptproxy rdptanalyzer rdpclient ;
alias libs    : libredrec ;


install install-bin
    : exe
    : <install-type>EXE <install-dependencies>on
    : <location>$(INSTALLDIR)/usr/local/bin
    ;

install install-share
    : [ glob sys/share/rdpproxy/[^.k]* ]
    :
    : <location>$(INSTALLDIR)/usr/local/share/rdpproxy
    ;

install install-etc
    : [ glob sys/etc/rdpproxy/*ini sys/etc/rdpproxy/*pem sys/etc/rdpproxy/*crt sys/etc/rdpproxy/*key sys/etc/rdpproxy/*p12 ]
    :
    : <location>$(INSTALLDIR)/etc/rdpproxy
    ;

install install-etc-themes
    : [ glob sys/etc/rdpproxy/themes/HOWTO ]
    :
    : <location>$(INSTALLDIR)/etc/rdpproxy/themes
    ;

install install-lib
    : libs
    :
    : <location>$(INSTALLDIR)/usr/lib
    ;

actions gen_redcryptofile {
    echo "$(>)" "$(<)" ;
    cp "$(>)" "$(<)"
    cp "$(<)" tools/redcryptofile/redcryptofile.so
}

explicit pycryptofile redcryptofile.so ;

#obj dummypng :
#        $(SRCDIR)/utils/dummypng.cpp
#    :
#    ;

lib pycryptofile :
        tools/redcryptofile/pycrypto.cpp
    :
        <define>REDPYTHON_BINDING
        <include>$(PYTHON_INCLUDE)
        <cxxflags>-fPIC
        <cflags>-fPIC
        <link>shared
        <library>snappy
        <library>python2
        <library>crypto
    ;

make redcryptofile.so
    :
        pycryptofile
    :
        @gen_redcryptofile
    ;

lib libboost_unit_test : : <name>boost_unit_test_framework <link>shared ;
lib openssl : : <name>ssl <link>shared ;

lib krb5 : : <name>krb5 <link>shared ;
lib gssglue : : <name>gssglue <link>shared ;

lib crypto : : <name>crypto <link>shared ;
lib z : : <name>z <link>shared ;
lib snappy : : <name>snappy <link>shared ;
# lib lzma : : <name>lzma <link>shared ;
lib dl : : <name>dl <link>shared ;
lib python2 : : <name>$(PYTHON_VER) <link>shared ;


lib libpng : : <name>png <link>shared ;
alias png : libpng z ;

# lib libasan : libboost_unit_test openssl krb5 gssglue crypto snappy png dl python2 : <name>asan ;

obj mainloop : $(SRCDIR)/core/mainloop.cpp ;
obj d3des : $(SRCDIR)/utils/d3des.cpp ;
obj bitmap : $(SRCDIR)/utils/bitmap_data_allocator.cpp ;
obj program_options : $(MODULEDIR)/program_options/src/program_options.cpp ;


constant COMMON_OBJ_DEPENDENCIES : <define>SHARE_PATH='\"$(PREFIX)/share/rdpproxy\"' ;
constant LIB_DEPENDENCIES : $(COMMON_OBJ_DEPENDENCIES) <cxxflags>-fPIC <cxxflags>-fvisibility=hidden ;
constant EXE_DEPENDENCIES : $(COMMON_OBJ_DEPENDENCIES) $(GCOV) ;
constant TEST_DEPENDENCIES :
    <include>$(TESTDIR)
    <cxxflags>-frtti
    <define>SHARE_PATH='\"$(FIXTURES_PATH)\"'
    <library>libboost_unit_test
    $(GCOV)
;


#
# Redemption
#

exe rdpproxy
    :
        $(SRCDIR)/main/main.cpp
        bitmap
        program_options

        mainloop

        d3des

        openssl
        crypto
        z
        dl
        png

        snappy
#        lzma

        krb5
        gssglue
    :
#         <link>static
        $(EXE_DEPENDENCIES)
    ;

lib libredrec
    :
        $(SRCDIR)/main/do_recorder.cpp
        bitmap
        program_options

        openssl
        crypto
        png
        z
        dl

        snappy
    :
        $(LIB_DEPENDENCIES)
    ;

exe rdptproxy
    :
        $(SRCDIR)/main/transparent.cpp
        bitmap
        program_options

        openssl
        crypto
        png
        z
        dl

        snappy
#        lzma

        krb5
        gssglue
    :
#         <link>static
        $(EXE_DEPENDENCIES)
    ;

exe rdptanalyzer
    :
        $(SRCDIR)/main/tanalyzer.cpp
        program_options

        openssl
        crypto
        png
        z
        dl

        snappy

        krb5
        gssglue
    :
#         <link>static
        $(EXE_DEPENDENCIES)
    ;

exe rdpclient
    : $(SRCDIR)/main/rdp_client.cpp
        program_options
        bitmap
        openssl
        crypto
        png
        z
        dl

        snappy
        krb5
        gssglue
    :
        $(EXE_DEPENDENCIES)
    ;


#
# Functional tests (run by hand)
#

exe tls_test_client
    :
        $(SRCDIR)/ftests/tls_test_client.cpp openssl crypto png dl snappy
    :
#         <link>static
        $(EXE_DEPENDENCIES)
 ;
exe tls_test_server
    :
        $(SRCDIR)/ftests/tls_test_server.cpp openssl crypto png dl snappy
    :
#         <link>static
        $(EXE_DEPENDENCIES)
;

exe make_cpp_config
    : $(SRCDIR)/main/write_cpp_config.cpp
    : <variant>asan:<library>libasan $(GCOV)
;

explicit make_cpp_config ;


#exe freetype_draw : ftests/freetype_draw.cpp freetype
#    : <link>static <variant>coverage:<library>gcov
#;

#add flag -I/usr/include/freetype2

#
# Unit Tests
#

#import testing-coverage ;
import testing ;

import type ;
type.register PYTHON : py ;

actions id {
    touch $(<);
}

import toolset ;

feature.feature <covfile> : : free ;
toolset.flags cover COVERFILE : <covfile> ;

feature.feature <covflag> : : free ;
toolset.flags cover COVERFLAG : <covflag> ;

actions cover
{
    echo "Computing coverage for $(COVERFILE)"
    if [ "++ $(COVERFLAG) ++" = "++ nocover ++" ]; then
        if [ ! -e "$(SRCDIR)/$(COVERFILE)" ]; then
            echo "source file $(SRCDIR)/$(COVERFILE) missing"
        fi
        echo "NO COVERAGE"
        touch "$(<)"
    else
        # echo "COVERFILE = $(COVERFILE)"
        # echo "source = $(>)"
        # echo "target = $(<)"
        mkdir -p $(COVERAGE_PREFIX)coverage/$(COVERFILE)
        if [ ! -e $(>:S=.gcno) ]; then
            echo "coverage file $(>:S=.gcno) does not exist"
            exit 1
        fi

        #echo "gcov --unconditional-branches --all-blocks --branch-count --branch-probabilities --function-summaries --demangled-names -o $(>:S=.gcno) $(>:S=) > $(COVERAGE_PREFIX)coverage/$(COVERFILE)/report.coverage"
        gcov --unconditional-branches --all-blocks --branch-count --branch-probabilities --function-summaries --demangled-names -o $(>:S=.gcno) $(>:S=) > $(COVERAGE_PREFIX)coverage/$(COVERFILE)/report.coverage
        if [ $? = "0" ]; then

            mv *.gcov $(COVERAGE_PREFIX)coverage/$(COVERFILE)
            if [ $? = "0" ]; then

                if [ ! -e "$(SRCDIR)/$(COVERFILE)" ]; then
                    echo "source file $(SRCDIR)/$(COVERFILE) missing"
                    exit 1
                fi

                # If no gcov file available for coverage target create an empty one
                if [ ! -e "$(COVERAGE_PREFIX)coverage/$(COVERFILE)/$(COVERFILE:B)$(COVERFILE:S).gcov" ]; then
                    touch $(COVERAGE_PREFIX)coverage/$(COVERFILE)/$(COVERFILE:B)$(COVERFILE:S).gcov
                fi

                etags -o $(COVERAGE_PREFIX)coverage/$(COVERFILE)/$(COVERFILE:B)$(COVERFILE:S).TAGS $(SRCDIR)/$(COVERFILE)
                if [ $? = "0" ]; then
                    python tools/coverage.py $(COVERFILE) $(COVERAGE_PREFIX)coverage/$(COVERFILE)/$(COVERFILE:B)$(COVERFILE:S).TAGS $(COVERAGE_PREFIX)coverage/$(COVERFILE)/$(COVERFILE:B)$(COVERFILE:S).gcov $(SRCDIR) > $(COVERAGE_PREFIX)coverage/$(COVERFILE)/$(COVERFILE:B)$(COVERFILE:S).report
                    cat $(COVERAGE_PREFIX)coverage/$(COVERFILE)/$(COVERFILE:B)$(COVERFILE:S).report
                    touch $(<)
                else
                    echo "etags failed"
                    exit 1
                fi
            else
                echo "gcov mv failed"
                exit 1
            fi
        else
            echo "gcov failed"
            exit 1
        fi
    fi
}

rule test-run ( target : sources + : tested ? : requirements * )
{
#    ECHO " TEST RUN" ;
    local ROOT_TEST_DIR = $(TESTDIR) ;
    if $(sources:P) = "system" {
        ROOT_TEST_DIR = $(SYSTEMTESTDIR) ;
    }
    sources = $(ROOT_TEST_DIR)/$(sources) ;

    local base = [ MATCH "test_(.*)$" : $(sources[0]:B) ] ;
    local basepath = "" ;
    local path = $(sources[0]:P) ;
    while $(path) != $(ROOT_TEST_DIR) {
        basepath = $(path:B)/$(basepath) ;
        path = $(path:P) ;
    }

#    ECHO "base = $(base)" ;
#    ECHO "sources = $(sources)" ;
#    ECHO "target = $(target)" ;
    run $(sources) : : : $(requirements) $(TEST_DEPENDENCIES) : $(target) ;

    if ($(tested)) {
        make $(target:S=.coverage) : $(target) : id
            : <variant>coverage:<action>@cover
              <covfile>$(tested) $(requirements)
            ;
    }
}

rule test-canonical ( base : requirements * )
{
    #basetarget = $(base:B) ;
    #base = $(base:P) ;
    #echo "base=" $(base) ;
    #while "$(base)" != "" {
    #    basetarget = $(base:B)_$(basetarget) ;
    #    base = $(base:P) ;
    #}
    #target = test_$(basetarget) ;

    target = test_$(base:B) ;
    source = $(base:P)/test_$(base:B).cpp ;
    tested = $(base) ;

    #echo "target=" $(target) ;
    #echo "source=" $(source) ;
    #echo "tested=" $(tested) ;


    test-run $(target) : $(source) : $(tested) : $(requirements) ;
}


# To compute coverage
# ===================
# bjam coverage test_utf.coverage

## Acl tests
## @{
test-canonical acl/acl_serializer.hpp ;
test-canonical acl/authentifier.hpp : <library>crypto <library>png ;
test-canonical acl/module_manager.hpp : <library>crypto <library>png ;
test-canonical acl/auth_api.hpp ;

## @}

## Capture tests
## @{
test-canonical capture/ChunkToFile.hpp ;
test-canonical capture/new_kbdcapture.hpp ;
test-canonical capture/RDPChunkedDevice.hpp ;
test-canonical capture/send_wrm_chunk.hpp ;
test-canonical capture/transparentchunk.hpp ;
test-canonical capture/transparentplayer.hpp ;
test-canonical capture/transparentrecorder.hpp ;
test-canonical capture/utils/save_state_chunk.hpp ;
test-canonical capture/wrm_label.hpp ;
test-canonical capture/FileToChunk.hpp : <library>png ;
test-canonical capture/image_capture.hpp : <library>bitmap <library>png ;
test-canonical capture/FileToGraphic.hpp : <library>bitmap <library>snappy <library>crypto <library>png ;
test-canonical capture/GraphicToFile.hpp : <library>bitmap <library>snappy <library>crypto <library>png ;
test-canonical capture/nativecapture.hpp : <library>bitmap <library>crypto <library>snappy <library>png ;
test-canonical capture/chunked_image_transport.hpp : <library>bitmap <library>png <library>z <library>snappy <library>crypto <library>png ;
test-canonical capture/capture.hpp : <library>bitmap <library>png <library>crypto <library>dl <library>z <library>snappy ;
test-canonical capture/utils/match_finder.hpp : <covflag>nocover ;

## @}

## Test facility functions or classes
## @{
test-canonical utils/sugar/algostring.hpp ;
test-canonical utils/sugar/array_view.hpp ;
test-canonical utils/sugar/local_fd.hpp ;
test-canonical utils/sugar/bytes_t.hpp ;
test-canonical utils/sugar/cast.hpp ;
test-canonical utils/sugar/exchange.hpp ;
test-canonical utils/sugar/finally.hpp ;
test-canonical utils/sugar/iter.hpp ;
test-canonical utils/sugar/make_unique.hpp ;
test-canonical utils/sugar/movable_noncopyable.hpp ;
test-canonical utils/sugar/noncopyable.hpp ;
test-canonical utils/sugar/range.hpp ;
test-canonical utils/sugar/splitter.hpp ;
test-canonical utils/sugar/strutils.hpp ;
test-canonical utils/sugar/underlying_cast.hpp ;
test-canonical utils/sugar/update_lock.hpp ;
test-canonical utils/sugar/numerics/safe_conversions.hpp ;
## @}

test-canonical utils/stream.hpp ;
test-canonical utils/utf.hpp ;
test-canonical utils/rect.hpp ;
test-canonical utils/ellipse.hpp ;
test-canonical utils/drawable.hpp : <library>bitmap  <library>crypto <library>png ;
test-canonical utils/protect_graphics.hpp : <library>bitmap <library>png ;
test-canonical utils/region.hpp ;
test-canonical utils/bitfu.hpp ;
test-canonical utils/parse.hpp ;
test-canonical utils/parser.hpp ;
test-canonical utils/fileutils.hpp ;
test-canonical utils/parse_ip_conntrack.hpp ;
test-canonical core/RDP/x224.hpp ;
test-canonical core/RDP/out_per_bstream.hpp ;
test-canonical core/RDP/mcs.hpp ;
test-canonical core/RDP/mppc.hpp ;
test-canonical core/RDP/mppc_40.hpp ;
test-canonical core/RDP/mppc_50.hpp ;
test-canonical core/RDP/mppc_60.hpp ;
test-canonical core/RDP/mppc_61.hpp ;
test-canonical core/RDP/gcc.hpp : <library>dl <library>z <library>crypto ;
test-canonical core/RDP/sec.hpp : <library>crypto ;
test-canonical core/RDP/lic.hpp : <library>crypto ;
test-canonical core/RDP/share.hpp ;
test-canonical core/RDP/fastpath.hpp : <library>crypto ;
test-canonical core/RDP/slowpath.hpp ;
test-canonical core/RDP/clipboard.hpp ;
test-canonical core/FSCC/FileInformation.hpp ;
test-canonical core/RDP/channels/rdpdr.hpp ;
test-canonical core/callback.hpp ;
test-canonical core/channel_list.hpp ;
test-canonical core/check_files.hpp ;
test-canonical core/client_info.hpp ;
test-canonical utils/theme.hpp   ;
test-canonical utils/confdescriptor.hpp ;
test-canonical core/error.hpp ;
test-canonical core/font.hpp ;
test-canonical core/listen.hpp ;
test-canonical core/mainloop.hpp ;
test-canonical core/RDP/bitmapupdate.hpp : <library>bitmap <library>crypto <library>libpng ;
test-canonical core/RDP/caches/bmpcache.hpp : <library>bitmap <library>crypto <library>png ;
test-canonical core/RDP/caches/bmpcachepersister.hpp : <library>bitmap <library>crypto ;
test-canonical core/RDP/caches/brushcache.hpp ;
test-canonical core/RDP/caches/glyphcache.hpp ;
test-canonical core/RDP/caches/pointercache.hpp ;
test-canonical utils/redirection_info.hpp ;

## Capabilities tests
## @{
test-canonical core/RDP/capabilities/bitmapcodecs.hpp ;
test-canonical core/RDP/capabilities/activate.hpp ;
test-canonical core/RDP/capabilities/cap_bitmap.hpp ;
test-canonical core/RDP/capabilities/cap_bmpcache.hpp ;
test-canonical core/RDP/capabilities/bitmapcachehostsupport.hpp ;
test-canonical core/RDP/capabilities/cap_brushcache.hpp ;
test-canonical core/RDP/capabilities/compdesk.hpp ;
test-canonical core/RDP/capabilities/control.hpp ;
test-canonical core/RDP/capabilities/drawgdiplus.hpp ;
test-canonical core/RDP/capabilities/drawninegridcache.hpp ;
test-canonical core/RDP/capabilities/cap_font.hpp ;
test-canonical core/RDP/capabilities/frameacknowledge.hpp ;
test-canonical core/RDP/capabilities/general.hpp ;
test-canonical core/RDP/capabilities/cap_glyphcache.hpp ;
test-canonical core/RDP/capabilities/input.hpp ;
test-canonical core/RDP/capabilities/largepointer.hpp ;
test-canonical core/RDP/capabilities/multifragmentupdate.hpp ;
test-canonical core/RDP/capabilities/offscreencache.hpp ;
test-canonical core/RDP/capabilities/order.hpp ;
#test-canonical core/RDP/capabilities/pointer.hpp ;
test-canonical core/RDP/capabilities/rail.hpp ;
test-canonical core/RDP/capabilities/cap_share.hpp ;
test-canonical core/RDP/capabilities/cap_sound.hpp ;
test-canonical core/RDP/capabilities/surfacecommands.hpp ;
test-canonical core/RDP/capabilities/window.hpp ;
test-canonical core/RDP/capabilities/bmpcache2.hpp ;
test-canonical core/RDP/capabilities/colcache.hpp ;
test-canonical core/RDP/capabilities/common.hpp ;
test-canonical core/RDP/capabilities/virchan.hpp ;
## @}

test-canonical core/RDP/ServerRedirection.hpp ;
test-canonical core/RDP/GraphicUpdatePDU.hpp ;
test-canonical core/RDP/RefreshRectPDU.hpp : <library>crypto ;
test-canonical core/RDP/logon.hpp ;
test-canonical core/RDP/nego.hpp : <library>openssl <library>crypto <library>dl <library>krb5 <library>gssglue ;
test-canonical core/RDP/orders/RDPOrdersCommon.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryMem3Blt.hpp ;
test-canonical core/RDP/orders/RDPOrdersSecondaryGlyphCache.hpp ;
test-canonical core/RDP/RDPDrawable.hpp : <library>crypto <library>png ;
test-canonical core/RDP/RDPSerializer.hpp ;
test-canonical core/RDP/remote_programs.hpp ;
test-canonical core/server.hpp ;
test-canonical core/session.hpp : <library>png ;
test-canonical core/session_server.hpp : <library>png ;
test-canonical core/wait_obj.hpp ;

test-run test_front : front/test_front.cpp : front/front.hpp
    : <library>bitmap <library>openssl
      <library>snappy <library>d3des
      <library>krb5 <library>gssglue
      <library>d3des
      <library>dl <library>crypto
      <library>png
    ;

test-canonical mod/mod_api.hpp ;
test-canonical mod/null/null.hpp ;
test-canonical mod/rdp/rdp_orders.hpp ;
test-canonical mod/rdp/channels/rdpdr_asynchronous_task.hpp ;
test-canonical mod/rdp/channels/cliprdr_channel.hpp : <library>png ;
test-canonical mod/rdp/channels/rdpdr_channel.hpp : <library>png ;
test-canonical mod/vnc/vnc.hpp : <library>png ;
test-canonical mod/xup/xup.hpp ;
test-canonical utils/bitmap.hpp : <library>bitmap <library>png <library>crypto ;
test-canonical utils/bitmap_with_png.hpp : <library>bitmap <library>png ;

test-run test_bitmap_perf
    : test_bitmap_perf.cpp
    :
    : <library>bitmap <library>png <covflag>nocover
    ;

test-canonical utils/colors.hpp ;
test-canonical utils/d3des.hpp ;
test-canonical utils/difftimeval.hpp ;
test-canonical utils/genrandom.hpp ;
test-canonical utils/log.hpp ;
test-canonical utils/netutils.hpp ;
test-canonical utils/png.hpp : <library>png ;
test-canonical utils/rdtsc.hpp ;

test-canonical utils/crypto/ssl_sha1_direct.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical utils/crypto/ssl_sha256_direct.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical utils/crypto/ssl_sha512_direct.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical utils/crypto/ssl_aes_direct.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical utils/crypto/ssl_md4_direct.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical utils/crypto/ssl_md5_direct.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical utils/crypto/ssl_rc4_direct.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical utils/crypto/ssl_lib.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical utils/crypto/ssl_sign.hpp : <library>openssl <library>crypto <library>dl <library>z ;

test-canonical system/linux/system/ssl_calls.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/openssl.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_aes.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_md4.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_md5.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_rc4.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_sha1.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_sha256.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_sha512.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_mod_exp.hpp : <library>openssl <library>crypto <library>dl <library>z ;

test-run test_strings : test_strings.cpp : : <covflag>nocover ;


## Transport tests
## @{
#test-canonical transport/detail/meta_writer.hpp ;

test-canonical transport/in_meta_sequence_transport.hpp : <library>crypto <library>snappy <library>dl <library>z ;

test-canonical transport/out_meta_sequence_transport.hpp : <library>crypto <library>snappy <library>dl <library>z ;
test-canonical transport/test_transport.hpp ;
test-canonical transport/count_transport.hpp ;
test-canonical transport/socket_transport.hpp : <library>openssl <library>crypto <library>dl ;
test-canonical transport/in_file_transport.hpp ;
test-canonical transport/out_file_transport.hpp ;
test-canonical transport/in_filename_transport.hpp : <library>z <library>dl <library>snappy <library>crypto ;
#test-canonical transport/out_filename_transport.hpp : <library>z <library>dl <library>snappy <library>crypto ;
test-canonical transport/gzip_compression_transport.hpp : <library>z ;
test-canonical transport/snappy_compression_transport.hpp : <library>snappy ;
test-canonical utils/apps/cryptofile.hpp : <library>openssl <library>crypto <library>snappy <library>dl <library>z ;
test-canonical utils/compression_transport_wrapper.hpp : <library>z <library>snappy ;
## @}


test-canonical core/RDP/orders/RDPOrdersPrimaryOpaqueRect.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryScrBlt.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryMemBlt.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryDestBlt.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryMultiDstBlt.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryMultiPatBlt.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryMultiScrBlt.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryMultiOpaqueRect.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryLineTo.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryPolygonSC.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryPolygonCB.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryPolyline.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryEllipseSC.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryEllipseCB.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryPatBlt.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryGlyphIndex.hpp ;
test-canonical core/RDP/orders/RDPOrdersSecondaryBmpCache.hpp : <library>bitmap <library>crypto ;
test-canonical core/RDP/orders/RDPOrdersSecondaryColorCache.hpp ;
test-canonical core/RDP/orders/RDPOrdersSecondaryBrushCache.hpp ;
test-canonical core/RDP/orders/AlternateSecondaryWindowing.hpp ;

test-run test_libpng
    : test_libpng.cpp
    :
    : <library>png <library>z <covflag>nocover
    ;

test-canonical mod/rdp/rdp.hpp
    : <library>bitmap <library>krb5
      <library>gssglue <library>png
      <library>d3des <library>z
      <library>dl <library>crypto
    ;

test-run test_rdp_client_test_card
    : client_mods/test_rdp_client_test_card.cpp
    :
    : <library>bitmap
      <library>z
      <library>png
      <library>crypto
      <library>dl
      <library>openssl
      <covflag>nocover
    ;
test-run test_rdp_client_tls_w2008
    : client_mods/test_rdp_client_tls_w2008.cpp
    :
    : <library>bitmap
      <library>krb5
      <library>gssglue
      <library>png
      <library>crypto
      <library>d3des
      <library>z
      <library>dl
      <library>openssl
      <covflag>nocover
    ;

test-run test_rdp_client_wab
    : client_mods/test_rdp_client_wab.cpp
    :
    : <library>bitmap
      <library>krb5
      <library>gssglue
      <library>png
      <library>crypto
      <library>d3des
      <library>openssl
      <library>dl
      <library>krb5
      <library>gssglue
      <covflag>nocover
    ;

test-run test_vnc_client_simple
    : client_mods/test_vnc_client_simple.cpp
    :
    : <library>bitmap
      <library>krb5
      <library>gssglue
      <library>png
      <library>crypto
      <library>d3des
      <library>dl
      <covflag>nocover
    ;

test-run test_rdesktop_client
    : server/test_rdesktop_client.cpp
    :
    : <library>bitmap
      <library>png
      <library>openssl
      <library>snappy
      <library>d3des
      <library>crypto
      <library>dl
      <covflag>nocover
    ;


test-run test_mstsc_client
    : server/test_mstsc_client.cpp
    :
    : <library>bitmap
      <library>png
      <library>openssl
      <library>snappy
      <library>d3des
      <library>crypto
      <library>dl
      <covflag>nocover
    ;


test-run test_mstsc_client_rdp50bulk
    : server/test_mstsc_client_rdp50bulk.cpp
    :
    : <library>bitmap
      <library>png
      <library>openssl
      <library>snappy
      <library>d3des
      <library>crypto
      <library>dl
      <covflag>nocover
    ;

if [ SHELL true ] {

test-run test_keymap2
    : test_keymap2.cpp
    : keyboard/keymap2.hpp
    ;

test-run test_keymapSym
    : test_keymapSym.cpp
    : keymapSym.hpp
    ;
}


## Widget tests
## @{
test-canonical mod/internal/widget2/widget2_rect.hpp : <library>png <library>crypto ;
test-canonical mod/internal/widget2/image.hpp : <library>bitmap <library>png <library>crypto ;
test-canonical mod/internal/widget2/label.hpp : <library>png <library>crypto ;
test-canonical mod/internal/widget2/tooltip.hpp : <library>png <library>crypto ;
test-canonical mod/internal/widget2/flat_button.hpp : <library>png <library>crypto ;
test-canonical mod/internal/widget2/edit.hpp : <library>png <library>crypto ;
test-canonical mod/internal/widget2/multiline.hpp : <library>png <library>crypto ;
test-canonical mod/internal/widget2/password.hpp : <library>png <library>crypto ;
test-canonical mod/internal/widget2/number_edit.hpp : <library>png <library>crypto ;
test-canonical mod/internal/widget2/edit_valid.hpp : <library>png <library>crypto ;
# test-run test_radio_list : mod/internal/widget2/test_radio_list.cpp : <library>png <library>libboost_unit_test ;
#test-canonical mod/internal/widget2/radio_list.hpp ;
test-canonical mod/internal/widget2/flat_dialog.hpp : <library>bitmap <library>png <library>crypto ;
test-canonical mod/internal/widget2/widget.hpp : <library>crypto ;
test-canonical mod/internal/widget2/composite.hpp : <library>png <library>crypto ;

#test-run test_window_dialog : mod/internal/widget2/test_window_dialog.cpp : <library>png <library>z <library>crypto <library>dl ;

test-canonical mod/internal/widget2/flat_login.hpp : <library>bitmap <library>png <library>crypto ;

test-canonical mod/internal/widget2/flat_wab_close.hpp : <library>bitmap <library>png <library>crypto ;
test-canonical mod/internal/widget2/screen.hpp : <library>png <library>crypto ;
# test-run test_columnlayout : mod/internal/widget2/test_columnlayout.cpp : <library>png ;
#test-canonical mod/internal/widget2/columnlayout.hpp ;
# test-run test_linelayout : mod/internal/widget2/test_linelayout.cpp : <library>png ;
#test-canonical mod/internal/widget2/linelayout.hpp ;
# test-run test_stacklayout : mod/internal/widget2/test_stacklayout.cpp : <library>png ;
#test-canonical mod/internal/widget2/stacklayout.hpp ;
test-canonical mod/internal/widget2/grid.hpp : <library>png <library>crypto ;
test-canonical mod/internal/widget2/labelgrid.hpp : <library>png <library>crypto ;
test-canonical mod/internal/widget2/flat_selector2.hpp : <library>png <library>crypto ;
test-canonical mod/internal/widget2/group_box.hpp : <library>png <library>crypto ;
# test-run test_scroll : mod/internal/widget2/test_scroll.cpp : <library>png ;
#test-canonical mod/internal/widget2/scroll.hpp ;
# test-run test_tab : mod/internal/widget2/test_tab.cpp : <library>png ;
#test-canonical mod/internal/widget2/tab.hpp ;
test-canonical mod/internal/widget2/flat_interactive_target.hpp : <library>png <library>crypto ;
## @}

## Mod tests
## @{
test-canonical mod/internal/flat_dialog_mod.hpp : <library>bitmap <library>png ;

test-canonical mod/internal/flat_login_mod.hpp : <library>bitmap <library>png ;

test-canonical mod/internal/flat_wab_close_mod.hpp : <library>bitmap <library>png ;
test-canonical mod/internal/widget_test_mod.hpp : <library>png ;
test-canonical mod/internal/interactive_target_mod.hpp : <library>bitmap <library>png <library>crypto ;
test-canonical mod/internal/bouncer2_mod.hpp : <library>png ;
test-canonical mod/internal/test_card_mod.hpp : <library>png ;
test-canonical mod/internal/replay_mod.hpp : <library>png ;
test-canonical mod/internal/internal_mod.hpp ;
test-canonical mod/internal/copy_paste.hpp : <library>png <library>crypto ;
## @}

## Regex tests
## @{
test-canonical regex/regex_state.hpp ;
test-canonical regex/regex_parser.hpp ;
test-canonical regex/regex_st_automate.hpp ;
test-canonical regex/regex.hpp ;

# test-run benchmark_regex_parser : benchmark/parser.cpp ;
# test-run benchmark_regex_search : benchmark/search.cpp ;
## @}

# test-run test_base64 : utils/test_base64.cpp : ;
test-canonical utils/translation.hpp ;


## NLA TESTS
## @{
test-canonical core/RDP/nla/asn1/ber.hpp ;
test-canonical core/RDP/nla/credssp.hpp : <library>crypto ;
test-canonical core/RDP/nla/sspi.hpp ;
test-canonical core/RDP/nla/nla.hpp : <library>dl <library>krb5 <library>gssglue <library>z <library>crypto ;

#alias test_ntlm_suite : test_ntlm_message_negotiate test_ntlm_avpair test_ntlm_message_challenge test_ntlm_message_authenticate test_ntlm_context ;

test-canonical core/RDP/nla/ntlm/ntlm_message_negotiate.hpp : <library>crypto ;
test-canonical core/RDP/nla/ntlm/ntlm_avpair.hpp ;
test-canonical core/RDP/nla/ntlm/ntlm_message_challenge.hpp : <library>crypto ;
test-canonical core/RDP/nla/ntlm/ntlm_message_authenticate.hpp : <library>crypto ;
test-canonical core/RDP/nla/ntlm/ntlm_context.hpp : <library>dl <library>z <library>crypto ;
test-canonical core/RDP/nla/ntlm/ntlm.hpp : <library>dl <library>z <library>crypto ;
test-canonical core/RDP/nla/kerberos/credentials.hpp : <library>krb5 ;
test-canonical core/RDP/nla/kerberos/kerberos.hpp : <library>krb5 <library>gssglue ;
## @}

## Widget for workflow
## @{
test-canonical mod/internal/widget2/flat_wait.hpp : <library>png <library>crypto ;
test-canonical mod/internal/widget2/flat_form.hpp : <library>png <library>crypto ;
## @}
test-canonical utils/authorization_channels.hpp ;
test-canonical utils/pattutils.hpp ;
test-canonical utils/diffiehellman.hpp ;

if [ SHELL false ] {

test-run test_verifier
    : test_verifier.cpp
    : verifier.hpp
    : <library>program_options
      <library>openssl
      <library>crypto
      <library>snappy
      <library>dl
      <library>z ;

}

actions pass {
    touch $(<)
}

actions run-python-test {
    rm -f $(<)
    python $(>[1]) && touch $(<)
}

make test_trace.py.unittest
    :
        tools/redcryptofile/test_trace.py
        redcryptofile.so
    :
        run-python-test
    :
        <variant>coverage:<action>@pass
    ;

lib gssapi_krb5 : : <name>gssapi_krb5 <link>shared ;
lib rt : : <name>rt <link>shared ;


explicit install-sashimi local-install-sashimi sashimi ;

install install-sashimi
    : sashimi
    : <location>debian/sashimi/usr/lib
    ;

install local-install-sashimi
    : sashimi
    : <location>/usr/lib
    ;

obj sashimi_error : $(SRCDIR)/sashimi/ssh_error.cpp ;
obj sashimi_pki : $(SRCDIR)/sashimi/pki.cpp ;
obj sashimi_channels : $(SRCDIR)/sashimi/channels.cpp ;
obj sashimi_sftp : $(SRCDIR)/sashimi/sftp.cpp ;
obj sashimi_libssh : $(SRCDIR)/sashimi/libssh.cpp ;

lib sashimi :
    sashimi_pki
    sashimi_channels
    sashimi_sftp
    sashimi_libssh
    sashimi_error
#    #openssl
    krb5
    gssapi_krb5
    crypto
    dl
    z
    rt
    :
    <link>shared
    :
    :
;

##
## Unit Tests
##

unit-test test_buffer :
    $(TESTDIR)/sashimi/test_buffer.cpp
    sashimi_error
    libboost_unit_test
    :
    $(TEST_DEPENDENCIES)
    ;

unit-test test_crypto :
    $(TESTDIR)/sashimi/test_crypto.cpp
    sashimi_error
    crypto
    libboost_unit_test
    :
    $(TEST_DEPENDENCIES)
    ;


test-canonical acl/mm_api.hpp ;
test-canonical core/activity_checker.hpp ;
test-canonical core/authid.hpp ;
test-canonical core/channel_names.hpp ;
test-canonical core/defines.hpp ;
test-canonical core/front_api.hpp ;
test-canonical core/RDP/autoreconnect.hpp ;
test-canonical core/RDP/capabilities.hpp ;
test-canonical core/RDP/mppc_unified_dec.hpp ;
test-canonical core/RDP/nla/ntlm/ntlm_message.hpp ;
test-canonical core/RDP/non_null_terminated_utf16_from_utf8.hpp ;
test-canonical core/RDP/orders/RDPOrdersSecondaryFrameMarker.hpp ;
test-canonical core/RDP/PersistentKeyListPDU.hpp ;
test-canonical core/RDP/pointer.hpp ;
test-canonical core/RDP/protocol.hpp ;
test-canonical core/RDP/SaveSessionInfoPDU.hpp ;
test-canonical core/server_notifier_api.hpp ;
test-canonical mod/internal/flat_selector2_mod.hpp ;
test-canonical mod/internal/flat_wait_mod.hpp ;
test-canonical mod/internal/transparent_replay_mod.hpp ;
test-canonical mod/internal/widget2/flat_vnc_authentification.hpp ;
test-canonical mod/internal/widget2/language_button.hpp ;
test-canonical mod/internal/widget2/layout.hpp ;
test-canonical mod/internal/widget2/notify_api.hpp ;
test-canonical mod/rdp/channels/base_channel.hpp ;
test-canonical mod/rdp/channels/rdpdr_file_system_drive_manager.hpp ;
test-canonical mod/rdp/channels/sespro_alternate_shell_based_launcher.hpp ;
test-canonical mod/rdp/channels/sespro_channel.hpp ;
test-canonical mod/rdp/channels/sespro_clipboard_based_launcher.hpp ;
test-canonical mod/rdp/channels/sespro_launcher.hpp ;
test-canonical mod/rdp/rdp_log.hpp ;
test-canonical mod/rdp/rdp_params.hpp ;
test-canonical regex/regex_automate.hpp ;
test-canonical regex/regex_consumer.hpp ;
test-canonical regex/regex_states_value.hpp ;
test-canonical regex/regex_utils.hpp ;

test-canonical utils/apps/app_decrypter.hpp :
    <library>program_options <library>openssl <library>crypto <library>snappy <library>dl <library>z ;

test-canonical utils/apps/app_proxy.hpp ;

test-canonical utils/apps/app_recorder.hpp :
    <library>program_options <library>openssl <library>crypto <library>snappy <library>dl <library>z ;

test-canonical utils/apps/app_verifier.hpp :
    <library>program_options <library>openssl <library>crypto <library>snappy <library>dl <library>z ;

test-canonical utils/apps/recording_progress.hpp ;
test-canonical utils/array.hpp ;

test-canonical utils/asynchronous_task_manager.hpp ;
test-canonical utils/bitmap_data_allocator.hpp ;
test-canonical utils/cfgloader.hpp ;
test-canonical utils/fdbuf.hpp ;
test-canonical utils/get_printable_password.hpp ;
test-canonical utils/outbound_connection_monitor_rules.hpp ;
#test-canonical utils/server_certificate.hpp ;
test-canonical utils/timeout.hpp ;
test-canonical utils/timeval_ops.hpp ;
test-canonical utils/urandom_read.hpp ;
test-canonical utils/virtual_channel_data_sender.hpp ;
test-canonical utils/winpr/pattern.hpp ;
